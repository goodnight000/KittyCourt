// ============================================
// KITTY COURT - PRISMA SCHEMA (LEGACY/LOCAL)
// ============================================
// 
// ‚ö†Ô∏è  NOTE: Supabase is now the PRIMARY database!
// 
// This Prisma schema is kept for:
//   - Local development/testing fallback
//   - Reference for data structure
//   - Server-side operations that don't need auth
//
// For production, use the Supabase schema at:
//   supabase/migrations/001_initial_schema.sql
//
// The User model has been removed - user data now lives
// in Supabase's auth.users + profiles tables.
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// DEPRECATED: User model removed
// ============================================
// User data is now managed by Supabase:
//   - auth.users (Supabase built-in auth)
//   - profiles (custom app data)
// 
// The Transaction model below is kept for local
// testing but should migrate to Supabase in production.
// ============================================

model Case {
  id              String    @id @default(uuid())
  
  // In Supabase, these reference profiles(id)
  userAId         String    @map("user_a_id")
  userBId         String    @map("user_b_id")
  
  userAInput      String?   @map("user_a_input")
  userAFeelings   String    @default("") @map("user_a_feelings")
  userBInput      String?   @map("user_b_input")
  userBFeelings   String    @default("") @map("user_b_feelings")
  
  status          String    @default("DRAFT") // DRAFT, LOCKED_A, DELIBERATING, RESOLVED
  
  // AI-generated metadata
  caseTitle       String?   @map("case_title")
  severityLevel   String?   @map("severity_level")
  primaryHissTag  String?   @map("primary_hiss_tag")
  shortResolution String?   @map("short_resolution")
  
  verdicts        Verdict[]
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("cases")
}

model Verdict {
  id           String   @id @default(uuid())
  caseId       String   @map("case_id")
  case         Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  version      Int      @default(1)
  content      String   // JSON string of the verdict
  
  addendumBy   String?  @map("addendum_by")
  addendumText String?  @map("addendum_text")
  
  createdAt    DateTime @default(now()) @map("created_at")
  
  @@index([caseId])
  @@map("verdicts")
}

// Legacy: Kept for local testing, use Supabase transactions table in production
model Transaction {
  id          String   @id @default(uuid())
  userId      String   @map("user_id") // References profiles(id) in Supabase
  
  amount      Int
  type        String   // EARN, SPEND
  description String
  
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("transactions")
}

model CourtSession {
  id          String   @id @default(uuid())
  
  status      String   @default("WAITING") // WAITING, IN_SESSION, CLOSED
  createdBy   String   @map("created_by") // References profiles(id)
  
  userAJoined Boolean  @default(false) @map("user_a_joined")
  userBJoined Boolean  @default(false) @map("user_b_joined")
  
  caseId      String?  @map("case_id")
  
  createdAt   DateTime @default(now()) @map("created_at")
  expiresAt   DateTime @map("expires_at")

  @@map("court_sessions")
}

model Appreciation {
  id           String   @id @default(uuid())
  
  fromUserId   String   @map("from_user_id")
  toUserId     String   @map("to_user_id")
  
  message      String
  category     String?
  kibbleAmount Int      @default(10) @map("kibble_amount")
  
  createdAt    DateTime @default(now()) @map("created_at")
  
  @@index([toUserId])
  @@index([fromUserId])
  @@map("appreciations")
}

model CalendarEvent {
  id          String   @id @default(uuid())
  
  createdBy   String   @map("created_by")
  
  title       String
  emoji       String   @default("üìÖ")
  date        DateTime @map("event_date")
  type        String?  @map("event_type")
  notes       String?
  
  isRecurring Boolean  @default(false) @map("is_recurring")
  recurrencePattern String? @map("recurrence_pattern")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@index([date])
  @@map("calendar_events")
}

model DailyAnswer {
  id           String   @id @default(uuid())
  
  userId       String   @map("user_id")
  questionDate DateTime @map("question_date")
  questionId   Int      @map("question_id")
  answer       String
  mood         String?
  
  createdAt    DateTime @default(now()) @map("created_at")
  
  @@unique([userId, questionDate])
  @@map("daily_answers")
}

// ============================================
// USER MEMORIES (AI-Gathered Insights)
// ============================================
// Stores behavioral patterns and insights gathered
// through cases, daily questions, and interactions.
// Used by Judge Whiskers for personalized verdicts.
// ============================================
model UserMemory {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  
  // Memory categorization
  category        String   // 'communication', 'triggers', 'strengths', 'patterns', 'preferences', 'growth'
  subcategory     String?  // More specific: 'conflict_triggers', 'love_expressions', etc.
  
  // The actual insight
  content         String   // The insight itself
  context         String?  // Where this was learned
  
  // Confidence and relevance
  confidence      Float    @default(0.7) // 0-1 confidence score
  timesObserved   Int      @default(1) @map("times_observed")
  lastObservedAt  DateTime @default(now()) @map("last_observed_at")
  
  // Source tracking
  sourceType      String   @map("source_type") // 'case', 'daily_meow', 'appreciation', 'onboarding'
  sourceId        String?  @map("source_id")
  
  // For AI context
  embeddingText   String?  @map("embedding_text")
  isActive        Boolean  @default(true) @map("is_active")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@index([userId])
  @@index([category])
  @@map("user_memories")
}

// ============================================
// USER PREFERENCES (Likes/Dislikes)
// ============================================
// Stores explicit likes and dislikes for gift
// suggestions, date planning, and personalization.
// ============================================
model UserPreference {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  
  // Preference type
  preferenceType  String   @map("preference_type") // 'like' or 'dislike'
  
  // What the preference is about
  itemName        String   @map("item_name")
  category        String   // 'food', 'activities', 'gifts', 'entertainment', 'travel', 'home', 'style', 'experiences'
  subcategory     String?
  
  // Strength of preference (1-5)
  preferenceLevel Int      @default(3) @map("preference_level")
  
  // Additional context
  notes           String?
  source          String   @default("explicit") // 'explicit', 'inferred', 'partner_told'
  mentionedAt     DateTime @default(now()) @map("mentioned_at")
  
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@index([preferenceType])
  @@map("user_preferences")
}
